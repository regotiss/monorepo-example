# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# this allows you to use CircleCI's dynamic configuration feature
setup: true


# the path-filtering orb is required to continue a pipeline based on
# the path of an updated fileset
orbs:
  path-filtering: circleci/path-filtering@0.1.1
  continuation: circleci/continuation@0.1.2
  node: circleci/node@5.0.2

parameters:
  configure:
    description: Run the configure step
    type: boolean
    default: true
  name:
    description: Name of the package being built
    type: string
    default: ""
  params:
    type: string
    default: "{}"


# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs

executors:
  node:
    docker:
      - image: public.ecr.aws/docker/library/node:16.10-buster

jobs:
  configure:
    working_directory: ~/code
    executor: node
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "bb:89:ad:27:20:7d:a0:4a:35:e8:51:eb:ff:b8:e4:7f"
      - run: |
          sh .circleci/scripts/trigger.sh
  trigger:
    executor: continuation/default
    steps:
      - checkout
      - continuation/continue:
          configuration_path: ./.circleci/continue_config.yml
          parameters: <<pipeline.parameters.params>>

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
    # the trigger workflow is always triggered, regardless of the pipeline parameters.
  version: 2
  configure:
    when: <<pipeline.parameters.configure>>
    jobs:
      - configure

  trigger:
    unless: <<pipeline.parameters.configure>>
    jobs:
      - trigger
